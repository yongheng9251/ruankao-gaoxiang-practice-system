<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¯è€ƒé«˜é¡¹åˆ·é¢˜ç³»ç»Ÿ - å…¨ç« èŠ‚ç‰ˆ</title>
    
    <!-- PWAç›¸å…³æ ‡ç­¾ï¼ˆä»…åœ¨HTTP/HTTPSç¯å¢ƒä¸‹ç”Ÿæ•ˆï¼‰ -->
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="è½¯è€ƒåˆ·é¢˜">
    <meta name="apple-mobile-web-app-status-bar-style" content="#667eea">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%23667eea'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='48' fill='white'>ğŸ“š</text></svg>">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#667eea">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .header { 
            background: white; padding: 30px; border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-bottom: 25px;
            text-align: center; position: relative; overflow: hidden;
        }
        .header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        h1 { color: #333; font-size: 28px; margin-bottom: 10px; }
        
        .control-panel {
            background: white; padding: 25px; border-radius: 15px; 
            margin-bottom: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .chapter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 5px;
        }
        .chapter-item {
            padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;
            cursor: pointer; transition: all 0.3s; font-size: 13px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .chapter-item:hover { border-color: #667eea; transform: translateY(-2px); }
        .chapter-item.active { 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; border-color: #667eea;
        }
        .chapter-item .count { font-size: 11px; opacity: 0.7; }
        
        .mode-selector {
            display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px; border: none; border-radius: 25px;
            cursor: pointer; font-size: 14px; font-weight: 600;
            transition: all 0.3s; flex: 1; min-width: 120px;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary { background: #f8f9fa; color: #666; border: 2px solid #e0e0e0; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        
        .stats-bar {
            background: white; padding: 20px; border-radius: 12px;
            margin-bottom: 20px; display: flex; justify-content: space-around;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); flex-wrap: wrap; gap: 15px;
        }
        .stat-item { text-align: center; flex: 1; min-width: 80px; }
        .stat-value { 
            font-size: 24px; font-weight: bold; 
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .stat-label { color: #999; font-size: 12px; margin-top: 5px; }
        
        .progress-container { margin-bottom: 20px; }
        .progress-bar {
            width: 100%; height: 8px; background: #f0f0f0;
            border-radius: 4px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease; border-radius: 4px;
        }
        .progress-text {
            text-align: center; margin-top: 5px; color: #666; font-size: 13px;
        }
        
        .question-card {
            background: white; padding: 35px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: none; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .question-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;
            flex-wrap: wrap; gap: 10px;
        }
        .question-meta { display: flex; gap: 10px; flex-wrap: wrap; }
        .tag {
            padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;
        }
        .tag-chapter { background: #e3f2fd; color: #1976d2; }
        .tag-source { background: #f3e5f5; color: #7b1fa2; }
        .tag-global-id { background: #e8f5e9; color: #388e3c; }
        
        .question-text {
            font-size: 18px; line-height: 1.8; color: #333;
            margin-bottom: 25px; font-weight: 500;
        }
        
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option {
            padding: 18px 20px; border: 2px solid #f0f0f0; border-radius: 12px;
            cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 15px;
            background: #fafafa;
        }
        .option:hover { border-color: #667eea; background: #f5f7ff; transform: translateX(5px); }
        .option.selected { border-color: #667eea; background: #e8ecff; }
        .option.correct { border-color: #4caf50; background: #e8f5e9; }
        .option.wrong { border-color: #f44336; background: #ffebee; }
        .option-label {
            width: 32px; height: 32px; border-radius: 50%; background: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #666; border: 2px solid #ddd; flex-shrink: 0;
        }
        .option.selected .option-label { background: #667eea; color: white; border-color: #667eea; }
        .option.correct .option-label { background: #4caf50; color: white; border-color: #4caf50; }
        .option.wrong .option-label { background: #f44336; color: white; border-color: #f44336; }
        
        .analysis-box {
            margin-top: 25px; padding: 25px; background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            border-radius: 15px; display: none; border-left: 5px solid #667eea;
        }
        .analysis-box.show { display: block; animation: fadeIn 0.5s; }
        .analysis-title { font-weight: bold; color: #667eea; margin-bottom: 10px; }
        
        .navigation {
            display: flex; justify-content: space-between; margin-top: 25px; gap: 15px;
        }
        .nav-btn {
            flex: 1; padding: 15px; border-radius: 12px; border: none;
            cursor: pointer; font-weight: 600; transition: all 0.3s;
        }
        .nav-prev { background: #f5f5f5; color: #666; }
        .nav-next { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .jump-selector {
            display: flex; gap: 10px; margin-top: 15px; align-items: center;
        }
        .jump-input {
            flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 14px;
        }
        
        .floating-actions {
            position: fixed; bottom: 30px; right: 30px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .fab {
            width: 50px; height: 50px; border-radius: 50%; background: white;
            border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer; font-size: 20px; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .fab:hover { transform: scale(1.1); }
        
        .loading {
            text-align: center; padding: 40px; color: white; font-size: 16px;
        }
        .spinner {
            display: inline-block; width: 40px; height: 40px;
            border: 4px solid rgba(255,255,255,0.3); border-radius: 50%;
            border-top-color: white; animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            .chapter-grid { grid-template-columns: 1fr; max-height: 200px; }
            .question-card { padding: 20px; }
            .question-text { font-size: 16px; }
            .floating-actions { bottom: 20px; right: 20px; }
            
            /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .container { 
                padding: 10px; 
                max-width: 100%;
            }
            
            .header {
                padding: 20px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .control-panel {
                padding: 20px;
                border-radius: 12px;
            }
            
            .chapter-item {
                padding: 10px;
                font-size: 12px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 13px;
                min-width: 100px;
            }
            
            .question-text {
                font-size: 16px;
                line-height: 1.6;
            }
            
            .options {
                gap: 10px;
            }
            
            .option {
                padding: 15px;
                gap: 10px;
            }
            
            .option-label {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
            
            .navigation {
                gap: 10px;
            }
            
            .nav-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .jump-input {
                padding: 8px;
                font-size: 13px;
            }
            
            .floating-actions {
                bottom: 20px;
                right: 20px;
            }
            
            .fab {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .stats-bar {
                padding: 15px;
                gap: 10px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .tag {
                padding: 3px 10px;
                font-size: 11px;
            }
            
            .file-upload-area {
                padding: 15px;
            }
            
            .file-button {
                padding: 8px 15px;
                font-size: 14px;
                margin: 5px 3px;
            }
            
            .return-home-btn {
                padding: 8px 15px;
                font-size: 13px;
            }
        }
        
        /* é’ˆå¯¹éå¸¸å°çš„å±å¹•ä¼˜åŒ– */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .header {
                padding: 15px;
            }
            
            h1 {
                font-size: 18px;
            }
            
            .chapter-grid {
                max-height: 150px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 80px;
            }
            
            .question-text {
                font-size: 15px;
            }
            
            .option {
                padding: 12px;
            }
            
            .nav-btn {
                padding: 10px;
            }
            
            .stat-value {
                font-size: 18px;
            }
        }
        
        /* è§¦æ‘¸ä¼˜åŒ– */
        .option {
            touch-action: manipulation;
            user-select: none;
        }
        
        /* éšè—æ»šåŠ¨æ¡ */
        .chapter-grid::-webkit-scrollbar {
            width: 6px;
        }
        
        .chapter-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .chapter-grid::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        .chapter-grid::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š è½¯è€ƒé«˜é¡¹æ™ºèƒ½åˆ·é¢˜ç³»ç»Ÿ</h1>
            <div id="globalStats">å‡†å¤‡å°±ç»ªï¼Œè¯·åŠ è½½é¢˜åº“</div>
        </div>

        <div id="fileUploadSection">
            <div class="file-upload-area" id="dropZone">
                <h3>ğŸ“ ä¸Šä¼ é¢˜åº“æ–‡ä»¶</h3>
                <p>å°† questions.json æ–‡ä»¶æ‹–æ‹½è‡³æ­¤ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ–‡ä»¶</p>
                <input type="file" id="fileInput" class="file-input" accept=".json">
                <button class="file-button" onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
                <button class="file-button" id="loadSampleBtn">åŠ è½½ç¤ºä¾‹æ•°æ®</button>
            </div>
        </div>

        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <div>æ­£åœ¨åŠ è½½é¢˜åº“...</div>
        </div>

        <div id="mainPanel" style="display:none">
            <div class="control-panel">
                <div style="margin-bottom:15px;font-weight:600;color:#333">ç« èŠ‚é€‰æ‹©ï¼ˆå¤šé€‰ï¼‰</div>
                <div class="chapter-grid" id="chapterGrid">
                    <!-- åŠ¨æ€åŠ è½½ç« èŠ‚ -->
                </div>
                
                <div class="mode-selector">
                    <button class="btn btn-primary" onclick="startPractice('sequence')">é¡ºåºç»ƒä¹ </button>
                    <button class="btn btn-secondary" onclick="startPractice('random')">éšæœºç»ƒä¹ </button>
                    <button class="btn btn-secondary" onclick="startPractice('wrong')">âŒ é”™é¢˜é‡ç»ƒ</button>
                    <button class="btn btn-secondary" onclick="startPractice('exam')">è®¡æ—¶è€ƒè¯•</button>
                </div>
            </div>
        </div>

        <div class="stats-bar" id="statsBar" style="display:none">
            <div class="stat-item">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">æ€»é¢˜æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statCurrent">0</div>
                <div class="stat-label">å½“å‰</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statCorrect">0</div>
                <div class="stat-label">æ­£ç¡®</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statWrong">0</div>
                <div class="stat-label">é”™è¯¯</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statRate">0%</div>
                <div class="stat-label">æ­£ç¡®ç‡</div>
            </div>
        </div>

        <div class="progress-container" id="progressContainer" style="display:none">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0 / 0</div>
        </div>

        <div class="question-card" id="questionCard">
            <div class="question-header">
                <div class="question-meta">
                    <span class="tag tag-chapter" id="qChapter">ç¬¬1ç« </span>
                    <span class="tag tag-source" id="qSource">æ•™æ</span>
                    <span class="tag tag-global-id" id="qId">æ€»ç¬¬1é¢˜</span>
                </div>
            </div>
            
            <div class="question-text" id="qText"></div>
            <div class="options" id="qOptions"></div>
            
            <div class="analysis-box" id="qAnalysis">
                <div class="analysis-title">ğŸ“– ç­”æ¡ˆè§£æ</div>
                <div id="qAnalysisText"></div>
            </div>

            <div class="navigation">
                <button class="nav-btn nav-prev" onclick="prevQuestion()">â† ä¸Šä¸€é¢˜</button>
                <button class="nav-btn nav-next" onclick="nextQuestion()">ä¸‹ä¸€é¢˜ â†’</button>
            </div>
            
            <div class="jump-selector">
                <input type="number" class="jump-input" id="jumpInput" placeholder="è¾“å…¥é¢˜å·è·³è½¬åˆ°..." min="1">
                <button class="btn btn-secondary" onclick="jumpToQuestion()">è·³è½¬</button>
            </div>
            
            <!-- æ–°å¢ï¼šè¿”å›é¦–é¡µæŒ‰é’® -->
            <div style="text-align: center; margin-top: 20px;">
                <button class="return-home-btn" onclick="returnHome()">è¿”å›é¦–é¡µ</button>
            </div>
        </div>
    </div>

    <div class="floating-actions">
        <button class="fab" onclick="toggleMark()" title="æ ‡è®°/å–æ¶ˆæ ‡è®°" id="markBtn">ğŸ”–</button>
        <button class="fab" onclick="exportData()" title="å¯¼å‡ºè¿›åº¦">ğŸ’¾</button>
        <button class="fab" onclick="document.getElementById('importFile').click()" title="å¯¼å…¥è¿›åº¦">ğŸ“‚</button>
        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(this)">
        <!-- æ–°å¢ï¼šæµ®åŠ¨è¿”å›é¦–é¡µæŒ‰é’® -->
        <button class="fab" onclick="returnHome()" title="è¿”å›é¦–é¡µ">ğŸ </button>
    </div>

    <script>
        let allQuestions = [];
        let filteredQuestions = [];
        let currentIndex = 0;
        let selectedChapters = new Set();
        let answeredQuestions = JSON.parse(localStorage.getItem('answered') || '{}');
        let wrongQuestions = JSON.parse(localStorage.getItem('wrong') || '[]');
        let markedQuestions = JSON.parse(localStorage.getItem('marked') || '[]');
        let examTimer = null;
        let examStartTime = null;

        // ä»æ–‡ä»¶åŠ è½½é¢˜åº“
        function loadQuestionsFromFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        resolve(jsonData);
                    } catch(err) {
                        reject(new Error('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šä¸æ˜¯æœ‰æ•ˆçš„JSONæ–‡ä»¶'));
                    }
                };
                reader.onerror = function() {
                    reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                };
                reader.readAsText(file);
            });
        }

        // ä»ç½‘ç»œåŠ è½½é¢˜åº“ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
        async function loadQuestionsFromUrl(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch(err) {
                console.warn('ä»URLåŠ è½½å¤±è´¥:', err);
                return null;
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        function initPage() {
            // è®¾ç½®æ‹–æ‹½äº‹ä»¶
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    processFile(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    processFile(e.target.files[0]);
                }
            });
            
            // åŠ è½½ç¤ºä¾‹æ•°æ®æŒ‰é’®
            document.getElementById('loadSampleBtn').addEventListener('click', loadSampleData);
        }

        // å¤„ç†æ–‡ä»¶
        async function processFile(file) {
            if (!file.name.endsWith('.json')) {
                alert('è¯·é€‰æ‹©JSONæ ¼å¼çš„é¢˜åº“æ–‡ä»¶');
                return;
            }
            
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('fileUploadSection').style.display = 'none';
            
            try {
                allQuestions = await loadQuestionsFromFile(file);
                finishLoading();
            } catch(err) {
                alert(`åŠ è½½æ–‡ä»¶å¤±è´¥: ${err.message}`);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('fileUploadSection').style.display = 'block';
            }
        }

        // åŠ è½½ç¤ºä¾‹æ•°æ®
        function loadSampleData() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('fileUploadSection').style.display = 'none';
            
            // åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®
            allQuestions = [
                {
                    id: 1,
                    local_id: 1,
                    source: "æ¨¡æ‹Ÿé¢˜",
                    chapter: "ç¬¬ä¸€ç«  ä¿¡æ¯åŒ–å‘å±•",
                    chapter_num: 1,
                    section: "1.1 ä¿¡æ¯ä¸ä¿¡æ¯åŒ–",
                    question: "ä»¥ä¸‹å…³äºä¿¡æ¯çš„æè¿°ï¼Œå“ªä¸€é¡¹æ˜¯æ­£ç¡®çš„ï¼Ÿ",
                    options: {
                        "A": "ä¿¡æ¯æ˜¯ç‰©è´¨çš„ä¸€ç§å±æ€§",
                        "B": "ä¿¡æ¯ä¸è½½ä½“å¯†ä¸å¯åˆ†",
                        "C": "ä¿¡æ¯æ˜¯ä¸€ç§èƒ½é‡",
                        "D": "ä¿¡æ¯å¯ä»¥è„±ç¦»è½½ä½“è€Œå­˜åœ¨"
                    },
                    answer: "A",
                    analysis: "ä¿¡æ¯æ˜¯å®¢è§‚äº‹ç‰©è¿åŠ¨çŠ¶æ€å’Œç‰¹å¾çš„åæ˜ ï¼Œæ˜¯ç‰©è´¨çš„ä¸€ç§å±æ€§ã€‚"
                },
                {
                    id: 2,
                    local_id: 2,
                    source: "æ¨¡æ‹Ÿé¢˜",
                    chapter: "ç¬¬ä¸€ç«  ä¿¡æ¯åŒ–å‘å±•",
                    chapter_num: 1,
                    section: "1.1 ä¿¡æ¯ä¸ä¿¡æ¯åŒ–",
                    question: "ä¿¡æ¯æŠ€æœ¯çš„æ ¸å¿ƒæ˜¯ï¼Ÿ",
                    options: {
                        "A": "è®¡ç®—æœºæŠ€æœ¯",
                        "B": "é€šä¿¡æŠ€æœ¯",
                        "C": "ä¼ æ„ŸæŠ€æœ¯",
                        "D": "æ§åˆ¶æŠ€æœ¯"
                    },
                    answer: "A",
                    analysis: "è®¡ç®—æœºæŠ€æœ¯æ˜¯ä¿¡æ¯æŠ€æœ¯çš„æ ¸å¿ƒï¼Œæ˜¯ä¿¡æ¯å¤„ç†çš„ä¸»è¦å·¥å…·ã€‚"
                },
                {
                    id: 3,
                    local_id: 1,
                    source: "æ¨¡æ‹Ÿé¢˜",
                    chapter: "ç¬¬äºŒç«  ä¿¡æ¯ç³»ç»Ÿç»¼åˆçŸ¥è¯†",
                    chapter_num: 2,
                    section: "2.1 ä¿¡æ¯ç³»ç»ŸåŸºç¡€",
                    question: "ä¿¡æ¯ç³»ç»Ÿçš„åŸºæœ¬ç»„æˆè¦ç´ åŒ…æ‹¬ï¼Ÿ",
                    options: {
                        "A": "ç¡¬ä»¶ã€è½¯ä»¶ã€æ•°æ®",
                        "B": "è¾“å…¥ã€å¤„ç†ã€è¾“å‡º",
                        "C": "äººã€ç¡¬ä»¶ã€è½¯ä»¶ã€æ•°æ®ã€æµç¨‹",
                        "D": "æ•°æ®åº“ã€ç½‘ç»œã€ç”¨æˆ·"
                    },
                    answer: "C",
                    analysis: "ä¿¡æ¯ç³»ç»Ÿçš„åŸºæœ¬ç»„æˆè¦ç´ åŒ…æ‹¬äººã€ç¡¬ä»¶ã€è½¯ä»¶ã€æ•°æ®å’Œæµç¨‹äº”ä¸ªæ–¹é¢ã€‚"
                }
            ];
            
            setTimeout(() => {
                finishLoading();
            }, 1000);
        }

        // å®ŒæˆåŠ è½½
        function finishLoading() {
            if (allQuestions.length === 0) {
                alert('é¢˜åº“ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('fileUploadSection').style.display = 'block';
                return;
            }
            
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('fileUploadSection').style.display = 'none'; // éšè—ä¸Šä¼ åŒºåŸŸ
            document.getElementById('mainPanel').style.display = 'block';
            
            // æ›´æ–°å…¨å±€ç»Ÿè®¡
            const uniqueChapters = [...new Set(allQuestions.map(q => q.chapter))].sort((a,b) => {
                const numA = parseInt(a.match(/\d+/)?.[0]) || 0;
                const numB = parseInt(b.match(/\d+/)?.[0]) || 0;
                return numA - numB;
            });
            
            document.getElementById('globalStats').textContent = 
                `å…± ${allQuestions.length} é“é¢˜ç›® Â· ${uniqueChapters.length} ä¸ªç« èŠ‚ Â· å·²ç­” ${Object.keys(answeredQuestions).length} é¢˜`;
            
            renderChapterGrid(uniqueChapters);
        }

        function renderChapterGrid(chapters) {
            const grid = document.getElementById('chapterGrid');
            
            // æ·»åŠ "å…¨é€‰"æŒ‰é’®
            const allBtn = document.createElement('div');
            allBtn.className = 'chapter-item active';
            allBtn.innerHTML = `<span>å…¨éƒ¨ç« èŠ‚</span><span class="count">${allQuestions.length}é¢˜</span>`;
            allBtn.onclick = () => toggleAllChapters(allBtn);
            grid.appendChild(allBtn);
            
            chapters.forEach(ch => {
                const count = allQuestions.filter(q => q.chapter === ch).length;
                const div = document.createElement('div');
                div.className = 'chapter-item';
                div.innerHTML = `<span>${ch}</span><span class="count">${count}é¢˜</span>`;
                div.onclick = () => toggleChapter(div, ch);
                grid.appendChild(div);
            });
        }

        function toggleAllChapters(btn) {
            const isActive = btn.classList.contains('active');
            document.querySelectorAll('.chapter-item').forEach(item => {
                item.classList.toggle('active', !isActive);
            });
            if (!isActive) {
                selectedChapters = new Set(allQuestions.map(q => q.chapter));
            } else {
                selectedChapters.clear();
            }
        }

        function toggleChapter(element, chapter) {
            element.classList.toggle('active');
            if (element.classList.contains('active')) {
                selectedChapters.add(chapter);
            } else {
                selectedChapters.delete(chapter);
            }
            
            // å¦‚æœå–æ¶ˆä¸€ä¸ªï¼Œä¹Ÿè¦å–æ¶ˆ"å…¨é€‰"çŠ¶æ€
            if (!element.classList.contains('active')) {
                document.querySelector('.chapter-item:first-child').classList.remove('active');
            }
        }

        function startPractice(mode) {
            if (selectedChapters.size === 0 && mode !== 'wrong') {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç« èŠ‚');
                return;
            }

            filteredQuestions = allQuestions.filter(q => 
                selectedChapters.has(q.chapter) || selectedChapters.size === 0
            );

            if (mode === 'wrong') {
                filteredQuestions = allQuestions.filter(q => wrongQuestions.includes(q.id));
                if (filteredQuestions.length === 0) {
                    alert('æš‚æ— é”™é¢˜ï¼');
                    return;
                }
            } else if (mode === 'random') {
                filteredQuestions = filteredQuestions.sort(() => Math.random() - 0.5);
            } else if (mode === 'exam') {
                // æ¨¡æ‹Ÿè€ƒè¯•ï¼š75é¢˜ï¼Œ75åˆ†é’Ÿ
                filteredQuestions = filteredQuestions.slice(0, 75);
                examStartTime = Date.now();
                examTimer = setInterval(updateExamTimer, 1000);
            }

            document.getElementById('mainPanel').style.display = 'none';
            document.getElementById('statsBar').style.display = 'flex';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('questionCard').style.display = 'block';
            
            currentIndex = 0;
            showQuestion();
            updateStats();
        }

        function updateExamTimer() {
            const elapsed = Math.floor((Date.now() - examStartTime) / 1000);
            const remaining = 75 * 60 - elapsed;
            if (remaining <= 0) {
                clearInterval(examTimer);
                alert('è€ƒè¯•æ—¶é—´åˆ°ï¼');
                return;
            }
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            document.querySelector('.header h1').textContent = 
                `ğŸ“š æ¨¡æ‹Ÿè€ƒè¯• - å‰©ä½™${mins}:${secs.toString().padStart(2,'0')}`;
        }

        function showQuestion() {
            const q = filteredQuestions[currentIndex];
            if (!q) return;

            document.getElementById('qChapter').textContent = q.chapter;
            document.getElementById('qSource').textContent = q.source;
            document.getElementById('qId').textContent = `æ€»ç¬¬${q.id}é¢˜`;
            document.getElementById('qText').textContent = q.question;
            
            // æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
            const markBtn = document.getElementById('markBtn');
            markBtn.textContent = markedQuestions.includes(q.id) ? 'ğŸ”´' : 'ğŸ”–';
            markBtn.style.color = markedQuestions.includes(q.id) ? 'red' : 'black';
            
            const optsContainer = document.getElementById('qOptions');
            optsContainer.innerHTML = '';
            Object.entries(q.options).forEach(([key, val]) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.innerHTML = `
                    <div class="option-label">${key}</div>
                    <div>${val}</div>
                `;
                div.onclick = () => selectOption(key, q.answer, div, q.id);
                optsContainer.appendChild(div);
            });

            // æ¢å¤ç­”é¢˜çŠ¶æ€
            const answered = answeredQuestions[q.id];
            if (answered) {
                const opts = document.querySelectorAll('.option');
                opts.forEach((opt, idx) => {
                    const key = Object.keys(q.options)[idx];
                    if (key === q.answer) opt.classList.add('correct');
                    if (key === answered && key !== q.answer) opt.classList.add('wrong');
                });
                showAnalysis(q);
            } else {
                document.getElementById('qAnalysis').classList.remove('show');
            }

            updateProgress();
        }

        function selectOption(selected, correct, element, qid) {
            if (answeredQuestions[qid]) return;
            
            answeredQuestions[qid] = selected;
            localStorage.setItem('answered', JSON.stringify(answeredQuestions));

            const q = filteredQuestions[currentIndex];
            
            if (selected === correct) {
                element.classList.add('correct');
                wrongQuestions = wrongQuestions.filter(id => id !== qid);
            } else {
                element.classList.add('wrong');
                document.querySelectorAll('.option').forEach((opt, idx) => {
                    if (Object.keys(q.options)[idx] === correct) opt.classList.add('correct');
                });
                if (!wrongQuestions.includes(qid)) wrongQuestions.push(qid);
            }
            localStorage.setItem('wrong', JSON.stringify(wrongQuestions));
            
            showAnalysis(q);
            updateStats();
        }

        function showAnalysis(q) {
            document.getElementById('qAnalysis').classList.add('show');
            document.getElementById('qAnalysisText').innerHTML = 
                `<strong>ç­”æ¡ˆï¼š${q.answer}</strong><br><br>${q.analysis || 'æš‚æ— è§£æ'}`;
        }

        function prevQuestion() {
            if (currentIndex > 0) {
                currentIndex--;
                showQuestion();
            }
        }

        function nextQuestion() {
            if (currentIndex < filteredQuestions.length - 1) {
                currentIndex++;
                showQuestion();
            } else {
                if (examTimer) clearInterval(examTimer);
                if (confirm('å·²å®Œæˆæ‰€æœ‰é¢˜ç›®ï¼æ˜¯å¦è¿”å›é¦–é¡µï¼Ÿ')) {
                    returnHome();
                }
            }
        }

        function jumpToQuestion() {
            const input = document.getElementById('jumpInput');
            const num = parseInt(input.value);
            if (num && num > 0 && num <= filteredQuestions.length) {
                currentIndex = num - 1;
                showQuestion();
                input.value = '';
            } else {
                alert('é¢˜å·è¶…å‡ºèŒƒå›´');
            }
        }

        function toggleMark() {
            const q = filteredQuestions[currentIndex];
            if (markedQuestions.includes(q.id)) {
                markedQuestions = markedQuestions.filter(id => id !== q.id);
            } else {
                markedQuestions.push(q.id);
            }
            localStorage.setItem('marked', JSON.stringify(markedQuestions));
            showQuestion();
        }

        function updateStats() {
            const total = filteredQuestions.length;
            const current = currentIndex + 1;
            const ids = filteredQuestions.map(q => q.id);
            const currentAnswered = Object.entries(answeredQuestions).filter(([id, ans]) => ids.includes(Number(id)));
            const correct = currentAnswered.filter(([id, ans]) => {
                const q = allQuestions.find(x => x.id == id);
                return q && q.answer === ans;
            }).length;
            const wrong = currentAnswered.length - correct;
            const rate = currentAnswered.length ? Math.round(correct / currentAnswered.length * 100) : 0;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statCurrent').textContent = current;
            document.getElementById('statCorrect').textContent = correct;
            document.getElementById('statWrong').textContent = wrong;
            document.getElementById('statRate').textContent = rate + '%';
        }

        function updateProgress() {
            const progress = ((currentIndex + 1) / filteredQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${currentIndex + 1} / ${filteredQuestions.length}`;
        }

        function exportData() {
            const data = {
                answeredQuestions,
                wrongQuestions,
                markedQuestions,
                exportTime: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è½¯è€ƒè¿›åº¦_${new Date().toLocaleDateString()}.json`;
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    Object.assign(answeredQuestions, data.answeredQuestions || {});
                    wrongQuestions = data.wrongQuestions || wrongQuestions;
                    markedQuestions = data.markedQuestions || markedQuestions;
                    localStorage.setItem('answered', JSON.stringify(answeredQuestions));
                    localStorage.setItem('wrong', JSON.stringify(wrongQuestions));
                    localStorage.setItem('marked', JSON.stringify(markedQuestions));
                    alert('å¯¼å…¥æˆåŠŸï¼');
                    location.reload();
                } catch(err) {
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯');
                }
            };
            reader.readAsText(file);
        }

        // æ–°å¢ï¼šè¿”å›é¦–é¡µåŠŸèƒ½
        function returnHome() {
            if (examTimer) clearInterval(examTimer);
            
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            document.getElementById('mainPanel').style.display = 'block';
            document.getElementById('statsBar').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('questionCard').style.display = 'none';
            
            // é‡ç½®è¿›åº¦æ¡
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0 / 0';
            
            // é‡ç½®é¢˜ç›®å¡å†…å®¹
            document.getElementById('qText').textContent = '';
            document.getElementById('qOptions').innerHTML = '';
            document.getElementById('qAnalysis').classList.remove('show');
            document.getElementById('qAnalysisText').innerHTML = '';
            
            // é‡ç½®ç»Ÿè®¡
            document.getElementById('statTotal').textContent = '0';
            document.getElementById('statCurrent').textContent = '0';
            document.getElementById('statCorrect').textContent = '0';
            document.getElementById('statWrong').textContent = '0';
            document.getElementById('statRate').textContent = '0%';
            
            // é‡ç½®ç´¢å¼•å’Œè¿‡æ»¤é—®é¢˜
            currentIndex = 0;
            filteredQuestions = [];
            
            // æ›´æ–°å…¨å±€ç»Ÿè®¡
            const uniqueChapters = [...new Set(allQuestions.map(q => q.chapter))].sort((a,b) => {
                const numA = parseInt(a.match(/\d+/)?.[0]) || 0;
                const numB = parseInt(b.match(/\d+/)?.[0]) || 0;
                return numA - numB;
            });
            
            document.getElementById('globalStats').textContent = 
                `å…± ${allQuestions.length} é“é¢˜ç›® Â· ${uniqueChapters.length} ä¸ªç« èŠ‚ Â· å·²ç­” ${Object.keys(answeredQuestions).length} é¢˜`;
        }

        // æ»‘åŠ¨æ‰‹åŠ¿æ”¯æŒ
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, false);

        document.addEventListener('touchend', (e) => {
            if (document.getElementById('questionCard').style.display === 'none') return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;
            
            // æ°´å¹³æ»‘åŠ¨è¶…è¿‡é˜ˆå€¼æ‰è§¦å‘
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                if (diffX > 0) {
                    nextQuestion(); // å‘å·¦æ»‘åŠ¨ï¼Œä¸‹ä¸€é¢˜
                } else {
                    prevQuestion(); // å‘å³æ»‘åŠ¨ï¼Œä¸Šä¸€é¢˜
                }
            }
        }, false);

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('questionCard').style.display === 'none') return;
            if (e.key === 'ArrowLeft') prevQuestion();
            if (e.key === 'ArrowRight') nextQuestion();
            if (e.key >= 'A' && e.key <= 'D') {
                const opts = document.querySelectorAll('.option');
                const idx = e.key.charCodeAt(0) - 65;
                if (opts[idx]) opts[idx].click();
            }
            // æ·»åŠ  ESC é”®è¿”å›é¦–é¡µ
            if (e.key === 'Escape') returnHome();
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            initPage();
            // æ–°å¢ï¼šè‡ªåŠ¨åŠ è½½é¢˜åº“
            try {
                // æ›¿æ¢ä¸ºä½ çš„ GitHub Pages åœ°å€ + /questions.json
                const url = 'https://yongheng9251.github.io/ruankao-gaoxiang-practice-system/questions.json';
                const data = await loadQuestionsFromUrl(url);
                if (data && data.length > 0) {
                    allQuestions = data;
                    finishLoading();
                }
            } catch (err) {
                console.log('è‡ªåŠ¨åŠ è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ é¢˜åº“æ–‡ä»¶');
            }
        });
    </script>
</body>
</html>