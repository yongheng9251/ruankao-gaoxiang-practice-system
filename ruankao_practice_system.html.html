<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËΩØËÄÉÈ´òÈ°πÂà∑È¢òÁ≥ªÁªü - ÂÖ®Á´†ËäÇÁâà</title>
    
    <!-- PWAÁõ∏ÂÖ≥Ê†áÁ≠æÔºà‰ªÖÂú®HTTP/HTTPSÁéØÂ¢É‰∏ãÁîüÊïàÔºâ -->
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="ËΩØËÄÉÂà∑È¢ò">
    <meta name="apple-mobile-web-app-status-bar-style" content="#667eea">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%23667eea'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='48' fill='white'>üìö</text></svg>">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#667eea">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .header { 
            background: white; padding: 30px; border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-bottom: 25px;
            text-align: center; position: relative; overflow: hidden;
        }
        .header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        h1 { color: #333; font-size: 28px; margin-bottom: 10px; }
        
        .control-panel {
            background: white; padding: 25px; border-radius: 15px; 
            margin-bottom: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .chapter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 5px;
        }
        .chapter-item {
            padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;
            cursor: pointer; transition: all 0.3s; font-size: 13px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .chapter-item:hover { border-color: #667eea; transform: translateY(-2px); }
        .chapter-item.active { 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; border-color: #667eea;
            animation: highlight 0.3s ease;
        }
        @keyframes highlight {
            from { transform: scale(0.98); opacity: 0.8; }
            to { transform: scale(1); opacity: 1; }
        }
        .chapter-item .count { font-size: 11px; opacity: 0.7; }
        
        .mode-selector {
            display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px; border: none; border-radius: 25px;
            cursor: pointer; font-size: 14px; font-weight: 600;
            transition: all 0.3s; flex: 1; min-width: 120px;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary { background: #f8f9fa; color: #666; border: 2px solid #e0e0e0; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        
        .stats-bar {
            background: white; padding: 20px; border-radius: 12px;
            margin-bottom: 20px; display: flex; justify-content: space-around;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); flex-wrap: wrap; gap: 15px;
        }
        .stat-item { text-align: center; flex: 1; min-width: 80px; }
        .stat-value { 
            font-size: 24px; font-weight: bold; 
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .stat-label { color: #999; font-size: 12px; margin-top: 5px; }
        
        .progress-container { margin-bottom: 20px; }
        .progress-bar {
            width: 100%; height: 8px; background: #f0f0f0;
            border-radius: 4px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease; border-radius: 4px;
        }
        .progress-text {
            text-align: center; margin-top: 5px; color: #666; font-size: 13px;
        }
        
        .question-card {
            background: white; padding: 35px; border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.12);
            display: none; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .question-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;
            flex-wrap: wrap; gap: 10px;
        }
        .question-meta { display: flex; gap: 10px; flex-wrap: wrap; }
        .tag {
            padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;
        }
        .tag-chapter { background: #e3f2fd; color: #1976d2; }
        .tag-source { background: #f3e5f5; color: #7b1fa2; }
        .tag-global-id { background: #e8f5e9; color: #388e3c; }
        
        .question-text {
            font-size: 18px; line-height: 1.8; color: #333;
            margin-bottom: 25px; font-weight: 500;
        }
        
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option {
            padding: 20px 22px; border: 2px solid #f0f0f0; border-radius: 12px;
            cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 15px;
            background: #fafafa;
        }
        .option:hover { border-color: #667eea; background: #f5f7ff; transform: translateX(5px); }
        .option.selected { border-color: #667eea; background: #e8ecff; }
        .option.correct { border-color: #4caf50; background: #e8f5e9; }
        .option.wrong { border-color: #f44336; background: #ffebee; }
        .option-label {
            width: 32px; height: 32px; border-radius: 50%; background: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #666; border: 2px solid #ddd; flex-shrink: 0;
        }
        .option.selected .option-label { background: #667eea; color: white; border-color: #667eea; }
        .option.correct .option-label { background: #4caf50; color: white; border-color: #4caf50; }
        .option.wrong .option-label { background: #f44336; color: white; border-color: #f44336; }
        
        .analysis-box {
            margin-top: 25px; padding: 25px; background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            border-radius: 15px; display: none; border-left: 5px solid #667eea;
        }
        .analysis-box.show { display: block; animation: fadeIn 0.5s; }
        .analysis-title { font-weight: bold; color: #667eea; margin-bottom: 10px; }
        
        .navigation {
            display: flex; justify-content: space-between; margin-top: 25px; gap: 15px;
        }
        .nav-btn {
            flex: 1; padding: 15px; border-radius: 12px; border: none;
            cursor: pointer; font-weight: 600; transition: all 0.3s;
        }
        .nav-prev { background: #f5f5f5; color: #666; }
        .nav-next { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .jump-selector {
            display: flex; gap: 10px; margin-top: 15px; align-items: center;
        }
        .jump-input {
            flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 14px;
        }
        
        .floating-actions {
            position: fixed; bottom: 30px; right: 30px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .fab {
            width: 50px; height: 50px; border-radius: 50%; background: white;
            border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer; font-size: 20px; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .fab:hover { transform: scale(1.1); }
        
        .loading {
            text-align: center; padding: 40px; color: white; font-size: 16px;
        }
        .spinner {
            display: inline-block; width: 40px; height: 40px;
            border: 4px solid rgba(255,255,255,0.3); border-radius: 50%;
            border-top-color: white; animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            .chapter-grid { grid-template-columns: 1fr; max-height: 200px; }
            .question-card { padding: 20px; }
            .question-text { font-size: 16px; }
            .floating-actions { bottom: 20px; right: 20px; }
            
            .container { 
                padding: 10px; 
                max-width: 100%;
            }
            
            .header {
                padding: 20px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .control-panel {
                padding: 20px;
                border-radius: 12px;
            }
            
            .chapter-item {
                padding: 10px;
                font-size: 12px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 13px;
                min-width: 100px;
            }
            
            .question-text {
                font-size: 16px;
                line-height: 1.6;
            }
            
            .options {
                gap: 10px;
            }
            
            .option {
                padding: 15px;
                gap: 10px;
            }
            
            .option-label {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
            
            .navigation {
                gap: 10px;
            }
            
            .nav-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .jump-input {
                padding: 8px;
                font-size: 13px;
            }
            
            .floating-actions {
                bottom: 20px;
                right: 20px;
            }
            
            .fab {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .stats-bar {
                padding: 15px;
                gap: 10px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .tag {
                padding: 3px 10px;
                font-size: 11px;
            }
            
            .file-upload-area {
                padding: 15px;
            }
            
            .file-button {
                padding: 8px 15px;
                font-size: 14px;
                margin: 5px 3px;
            }
            
            .return-home-btn {
                padding: 8px 15px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .header {
                padding: 15px;
            }
            
            h1 {
                font-size: 18px;
            }
            
            .chapter-grid {
                max-height: 150px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 80px;
            }
            
            .question-text {
                font-size: 15px;
            }
            
            .option {
                padding: 12px;
            }
            
            .nav-btn {
                padding: 10px;
            }
            
            .stat-value {
                font-size: 18px;
            }
        }
        
        .option {
            touch-action: manipulation;
            user-select: none;
        }
        
        .chapter-grid::-webkit-scrollbar {
            width: 6px;
        }
        
        .chapter-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .chapter-grid::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        .chapter-grid::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö ËΩØËÄÉÈ´òÈ°πÊô∫ËÉΩÂà∑È¢òÁ≥ªÁªü</h1>
            <div id="globalStats">ÂáÜÂ§áÂ∞±Áª™ÔºåËØ∑Âä†ËΩΩÈ¢òÂ∫ì</div>
        </div>

        <div id="fileUploadSection">
            <div class="file-upload-area" id="dropZone">
                <h3>üìÅ ‰∏ä‰º†È¢òÂ∫ìÊñá‰ª∂</h3>
                <p>Â∞Ü questions.json Êñá‰ª∂ÊãñÊãΩËá≥Ê≠§ÔºåÊàñÁÇπÂáª‰∏ãÊñπÊåâÈíÆÈÄâÊã©Êñá‰ª∂</p>
                <input type="file" id="fileInput" class="file-input" accept=".json">
                <button class="file-button" onclick="document.getElementById('fileInput').click()">ÈÄâÊã©Êñá‰ª∂</button>
                <button class="file-button" id="loadSampleBtn">Âä†ËΩΩÁ§∫‰æãÊï∞ÊçÆ</button>
            </div>
        </div>

        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <div>Ê≠£Âú®Âä†ËΩΩÈ¢òÂ∫ì...</div>
        </div>

        <div id="mainPanel" style="display:none">
            <div class="control-panel">
                <button class="btn btn-primary" id="resumeBtn" style="display:none; margin-bottom:15px; width:100%;">ÁªßÁª≠‰∏äÊ¨°ÁªÉ‰π†</button>
                
                <div style="margin-bottom:15px;font-weight:600;color:#333">Á´†ËäÇÈÄâÊã©ÔºàÂ§öÈÄâÔºâ</div>
                <div class="chapter-grid" id="chapterGrid">
                    <!-- Âä®ÊÄÅÂä†ËΩΩÁ´†ËäÇ -->
                </div>
                
                <div class="mode-selector">
                    <button class="btn btn-primary" onclick="startPractice('sequence')">È°∫Â∫èÁªÉ‰π†</button>
                    <button class="btn btn-secondary" onclick="startPractice('random')">ÈöèÊú∫ÁªÉ‰π†</button>
                    <button class="btn btn-secondary" onclick="startPractice('wrong')">‚ùå ÈîôÈ¢òÈáçÁªÉ</button>
                    <button class="btn btn-secondary" onclick="startPractice('exam')">ËÆ°Êó∂ËÄÉËØï</button>
                    <button class="btn btn-secondary" onclick="startPractice('collected')">Êî∂ËóèÂ§πÁªÉ‰π†</button>
                </div>
            </div>
        </div>

        <div class="stats-bar" id="statsBar" style="display:none">
            <div class="stat-item">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">ÊÄªÈ¢òÊï∞</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statCurrent">0</div>
                <div class="stat-label">ÂΩìÂâç</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statCorrect">0</div>
                <div class="stat-label">Ê≠£Á°Æ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statWrong">0</div>
                <div class="stat-label">ÈîôËØØ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statRate">0%</div>
                <div class="stat-label">Ê≠£Á°ÆÁéá</div>
            </div>
        </div>

        <div class="progress-container" id="progressContainer" style="display:none">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0 / 0</div>
        </div>

        <div class="question-card" id="questionCard">
            <div class="question-header">
                <div class="question-meta">
                    <span class="tag tag-chapter" id="qChapter">Á¨¨1Á´†</span>
                    <span class="tag tag-source" id="qSource">ÊïôÊùê</span>
                    <span class="tag tag-global-id" id="qId">ÊÄªÁ¨¨1È¢ò</span>
                </div>
                <button class="btn" id="collectBtn" style="padding:6px 12px; font-size:12px; border-radius:8px;">Êî∂ËóèÈ¢òÁõÆ</button>
            </div>
            
            <div class="question-text" id="qText"></div>
            <div class="options" id="qOptions"></div>
            
            <div class="analysis-box" id="qAnalysis">
                <div class="analysis-title">üìñ Á≠îÊ°àËß£Êûê</div>
                <div id="qAnalysisText"></div>
            </div>

            <div class="navigation">
                <button class="nav-btn nav-prev" onclick="prevQuestion()">‚Üê ‰∏ä‰∏ÄÈ¢ò</button>
                <button class="nav-btn nav-next" onclick="nextQuestion()">‰∏ã‰∏ÄÈ¢ò ‚Üí</button>
            </div>
            
            <div class="jump-selector">
                <input type="number" class="jump-input" id="jumpInput" placeholder="ËæìÂÖ•È¢òÂè∑Ë∑≥ËΩ¨Âà∞..." min="1">
                <button class="btn btn-secondary" onclick="jumpToQuestion()">Ë∑≥ËΩ¨</button>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="return-home-btn" onclick="returnHome()">ËøîÂõûÈ¶ñÈ°µ</button>
            </div>
        </div>
    </div>

    <div class="floating-actions">
        <button class="fab" onclick="toggleMark()" title="Ê†áËÆ∞/ÂèñÊ∂àÊ†áËÆ∞" id="markBtn">üîñ</button>
        <button class="fab" onclick="exportData()" title="ÂØºÂá∫ËøõÂ∫¶">üíæ</button>
        <button class="fab" onclick="document.getElementById('importFile').click()" title="ÂØºÂÖ•ËøõÂ∫¶">üìÇ</button>
        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(this)">
        <button class="fab" onclick="showWrongAnalysis()" title="ÈîôÈ¢òËß£ÊûêÊ±áÊÄª">üìã</button>
        <button class="fab" onclick="returnHome()" title="ËøîÂõûÈ¶ñÈ°µ">üè†</button>
    </div>

    <script>
        let allQuestions = [];
        let filteredQuestions = [];
        let currentIndex = 0;
        let selectedChapters = new Set();
        let answeredQuestions = JSON.parse(localStorage.getItem('answered') || '{}');
        let wrongQuestions = JSON.parse(localStorage.getItem('wrong') || '[]');
        let markedQuestions = JSON.parse(localStorage.getItem('marked') || '[]');
        let collectedQuestions = JSON.parse(localStorage.getItem('collected') || '[]');
        let examTimer = null;
        let examStartTime = null;
        let currentMode = '';

        function loadQuestionsFromFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        resolve(jsonData);
                    } catch(err) {
                        reject(new Error('Êñá‰ª∂Ê†ºÂºèÈîôËØØÔºö‰∏çÊòØÊúâÊïàÁöÑJSONÊñá‰ª∂'));
                    }
                };
                reader.onerror = function() {
                    reject(new Error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•'));
                };
                reader.readAsText(file);
            });
        }

        async function loadQuestionsFromUrl(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch(err) {
                console.warn('‰ªéURLÂä†ËΩΩÂ§±Ë¥•:', err);
                return null;
            }
        }

        function initPage() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    processFile(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    processFile(e.target.files[0]);
                }
            });
            
            document.getElementById('loadSampleBtn').addEventListener('click', loadSampleData);
        }

        async function processFile(file) {
            if (!file.name.endsWith('.json')) {
                alert('ËØ∑ÈÄâÊã©JSONÊ†ºÂºèÁöÑÈ¢òÂ∫ìÊñá‰ª∂');
                return;
            }
            
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('fileUploadSection').style.display = 'none';
            
            try {
                allQuestions = await loadQuestionsFromFile(file);
                finishLoading();
            } catch(err) {
                alert(`Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•: ${err.message}`);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('fileUploadSection').style.display = 'block';
            }
        }

        function loadSampleData() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('fileUploadSection').style.display = 'none';
            
            allQuestions = [
                {
                    id: 1,
                    local_id: 1,
                    source: "Ê®°ÊãüÈ¢ò",
                    chapter: "Á¨¨‰∏ÄÁ´† ‰ø°ÊÅØÂåñÂèëÂ±ï",
                    chapter_num: 1,
                    section: "1.1 ‰ø°ÊÅØ‰∏é‰ø°ÊÅØÂåñ",
                    question: "‰ª•‰∏ãÂÖ≥‰∫é‰ø°ÊÅØÁöÑÊèèËø∞ÔºåÂì™‰∏ÄÈ°πÊòØÊ≠£Á°ÆÁöÑÔºü",
                    options: {
                        "A": "‰ø°ÊÅØÊòØÁâ©Ë¥®ÁöÑ‰∏ÄÁßçÂ±ûÊÄß",
                        "B": "‰ø°ÊÅØ‰∏éËΩΩ‰ΩìÂØÜ‰∏çÂèØÂàÜ",
                        "C": "‰ø°ÊÅØÊòØ‰∏ÄÁßçËÉΩÈáè",
                        "D": "‰ø°ÊÅØÂèØ‰ª•ËÑ±Á¶ªËΩΩ‰ΩìËÄåÂ≠òÂú®"
                    },
                    answer: "A",
                    analysis: "‰ø°ÊÅØÊòØÂÆ¢ËßÇ‰∫ãÁâ©ËøêÂä®Áä∂ÊÄÅÂíåÁâπÂæÅÁöÑÂèçÊò†ÔºåÊòØÁâ©Ë¥®ÁöÑ‰∏ÄÁßçÂ±ûÊÄß„ÄÇ"
                },
                {
                    id: 2,
                    local_id: 2,
                    source: "Ê®°ÊãüÈ¢ò",
                    chapter: "Á¨¨‰∏ÄÁ´† ‰ø°ÊÅØÂåñÂèëÂ±ï",
                    chapter_num: 1,
                    section: "1.1 ‰ø°ÊÅØ‰∏é‰ø°ÊÅØÂåñ",
                    question: "‰ø°ÊÅØÊäÄÊúØÁöÑÊ†∏ÂøÉÊòØÔºü",
                    options: {
                        "A": "ËÆ°ÁÆóÊú∫ÊäÄÊúØ",
                        "B": "ÈÄö‰ø°ÊäÄÊúØ",
                        "C": "‰º†ÊÑüÊäÄÊúØ",
                        "D": "ÊéßÂà∂ÊäÄÊúØ"
                    },
                    answer: "A",
                    analysis: "ËÆ°ÁÆóÊú∫ÊäÄÊúØÊòØ‰ø°ÊÅØÊäÄÊúØÁöÑÊ†∏ÂøÉÔºåÊòØ‰ø°ÊÅØÂ§ÑÁêÜÁöÑ‰∏ªË¶ÅÂ∑•ÂÖ∑„ÄÇ"
                },
                {
                    id: 3,
                    local_id: 1,
                    source: "Ê®°ÊãüÈ¢ò",
                    chapter: "Á¨¨‰∫åÁ´† ‰ø°ÊÅØÁ≥ªÁªüÁªºÂêàÁü•ËØÜ",
                    chapter_num: 2,
                    section: "2.1 ‰ø°ÊÅØÁ≥ªÁªüÂü∫Á°Ä",
                    question: "‰ø°ÊÅØÁ≥ªÁªüÁöÑÂü∫Êú¨ÁªÑÊàêË¶ÅÁ¥†ÂåÖÊã¨Ôºü",
                    options: {
                        "A": "Á°¨‰ª∂„ÄÅËΩØ‰ª∂„ÄÅÊï∞ÊçÆ",
                        "B": "ËæìÂÖ•„ÄÅÂ§ÑÁêÜ„ÄÅËæìÂá∫",
                        "C": "‰∫∫„ÄÅÁ°¨‰ª∂„ÄÅËΩØ‰ª∂„ÄÅÊï∞ÊçÆ„ÄÅÊµÅÁ®ã",
                        "D": "Êï∞ÊçÆÂ∫ì„ÄÅÁΩëÁªú„ÄÅÁî®Êà∑"
                    },
                    answer: "C",
                    analysis: "‰ø°ÊÅØÁ≥ªÁªüÁöÑÂü∫Êú¨ÁªÑÊàêË¶ÅÁ¥†ÂåÖÊã¨‰∫∫„ÄÅÁ°¨‰ª∂„ÄÅËΩØ‰ª∂„ÄÅÊï∞ÊçÆÂíåÊµÅÁ®ã‰∫î‰∏™ÊñπÈù¢„ÄÇ"
                }
            ];
            
            setTimeout(() => {
                finishLoading();
            }, 1000);
        }

        function finishLoading() {
            if (allQuestions.length === 0) {
                alert('È¢òÂ∫ì‰∏∫Á©∫ÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ');
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('fileUploadSection').style.display = 'block';
                return;
            }
            
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('fileUploadSection').style.display = 'none';
            document.getElementById('mainPanel').style.display = 'block';
            
            const uniqueChapters = [...new Set(allQuestions.map(q => q.chapter))].sort((a,b) => {
                const numA = parseInt(a.match(/\d+/)?.[0]) || 0;
                const numB = parseInt(b.match(/\d+/)?.[0]) || 0;
                return numA - numB;
            });
            
            document.getElementById('globalStats').textContent = 
                `ÂÖ± ${allQuestions.length} ÈÅìÈ¢òÁõÆ ¬∑ ${uniqueChapters.length} ‰∏™Á´†ËäÇ ¬∑ Â∑≤Á≠î ${Object.keys(answeredQuestions).length} È¢ò`;
            
            renderChapterGrid(uniqueChapters);
            
            const lastProgress = JSON.parse(localStorage.getItem('practiceProgress'));
            if (lastProgress) {
                document.getElementById('resumeBtn').style.display = 'block';
                document.getElementById('resumeBtn').onclick = function() {
                    selectedChapters = new Set(lastProgress.chapters);
                    document.querySelectorAll('.chapter-item').forEach(item => {
                        const chapterName = item.querySelector('span').textContent;
                        item.classList.toggle('active', selectedChapters.has(chapterName));
                    });
                    startPractice(lastProgress.mode);
                    currentIndex = lastProgress.index;
                    showQuestion();
                };
            }
        }

        function renderChapterGrid(chapters) {
            const grid = document.getElementById('chapterGrid');
            grid.innerHTML = '';
            
            const allBtn = document.createElement('div');
            const allWrongCount = wrongQuestions.length;
            allBtn.className = 'chapter-item active';
            allBtn.innerHTML = `<span>ÂÖ®ÈÉ®Á´†ËäÇ</span><span class="count">${allWrongCount}ÈîôÈ¢ò / ${allQuestions.length}È¢ò</span>`;
            allBtn.onclick = () => toggleAllChapters(allBtn);
            grid.appendChild(allBtn);
            
            chapters.forEach(ch => {
                const chapterQuestions = allQuestions.filter(q => q.chapter === ch);
                const wrongCount = chapterQuestions.filter(q => wrongQuestions.includes(q.id)).length;
                const div = document.createElement('div');
                div.className = 'chapter-item';
                div.innerHTML = `<span>${ch}</span><span class="count">${wrongCount}ÈîôÈ¢ò / ${chapterQuestions.length}È¢ò</span>`;
                div.onclick = () => toggleChapter(div, ch);
                grid.appendChild(div);
            });
        }

        function toggleAllChapters(btn) {
            const isActive = btn.classList.contains('active');
            document.querySelectorAll('.chapter-item').forEach(item => {
                item.classList.toggle('active', !isActive);
            });
            if (!isActive) {
                selectedChapters = new Set(allQuestions.map(q => q.chapter));
            } else {
                selectedChapters.clear();
            }
        }

        function toggleChapter(element, chapter) {
            element.classList.toggle('active');
            if (element.classList.contains('active')) {
                selectedChapters.add(chapter);
            } else {
                selectedChapters.delete(chapter);
            }
            
            if (!element.classList.contains('active')) {
                document.querySelector('.chapter-item:first-child').classList.remove('active');
            }
        }

        function startPractice(mode) {
            currentMode = mode;
            if (selectedChapters.size === 0 && mode !== 'wrong' && mode !== 'collected') {
                alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Á´†ËäÇ');
                return;
            }

            filteredQuestions = allQuestions.filter(q => 
                selectedChapters.has(q.chapter) || selectedChapters.size === 0
            );

            if (mode === 'wrong') {
                filteredQuestions = allQuestions.filter(q => wrongQuestions.includes(q.id));
                if (filteredQuestions.length === 0) {
                    alert('ÊöÇÊó†ÈîôÈ¢òÔºÅ');
                    return;
                }
            } else if (mode === 'random') {
                filteredQuestions = filteredQuestions.sort(() => Math.random() - 0.5);
            } else if (mode === 'exam') {
                filteredQuestions = filteredQuestions.slice(0, 75);
                examStartTime = Date.now();
                examTimer = setInterval(updateExamTimer, 1000);
            } else if (mode === 'collected') {
                filteredQuestions = allQuestions.filter(q => collectedQuestions.includes(q.id));
                if (filteredQuestions.length === 0) {
                    alert('ÊöÇÊó†Êî∂ËóèÈ¢òÁõÆÔºÅ');
                    return;
                }
            }

            document.getElementById('mainPanel').style.display = 'none';
            document.getElementById('statsBar').style.display = 'flex';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('questionCard').style.display = 'block';
            
            currentIndex = 0;
            showQuestion();
            updateStats();
        }

        function updateExamTimer() {
            const elapsed = Math.floor((Date.now() - examStartTime) / 1000);
            const remaining = 75 * 60 - elapsed;
            if (remaining <= 0) {
                clearInterval(examTimer);
                alert('ËÄÉËØïÊó∂Èó¥Âà∞ÔºÅ');
                return;
            }
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            document.querySelector('.header h1').textContent = 
                `üìö Ê®°ÊãüËÄÉËØï - Ââ©‰Ωô${mins}:${secs.toString().padStart(2,'0')}`;
        }

        function showQuestion() {
            const q = filteredQuestions[currentIndex];
            if (!q) return;

            document.getElementById('qChapter').textContent = q.chapter;
            document.getElementById('qSource').textContent = q.source;
            document.getElementById('qId').textContent = `ÊÄªÁ¨¨${q.id}È¢ò`;
            document.getElementById('qText').textContent = q.question;
            
            const collectBtn = document.getElementById('collectBtn');
            if (collectedQuestions.includes(q.id)) {
                collectBtn.textContent = 'Â∑≤Êî∂Ëóè';
                collectBtn.style.background = '#f44336';
                collectBtn.style.color = 'white';
            } else {
                collectBtn.textContent = 'Êî∂ËóèÈ¢òÁõÆ';
                collectBtn.style.background = '#f8f9fa';
                collectBtn.style.color = '#666';
            }
            collectBtn.onclick = function() {
                if (collectedQuestions.includes(q.id)) {
                    collectedQuestions = collectedQuestions.filter(id => id !== q.id);
                    this.textContent = 'Êî∂ËóèÈ¢òÁõÆ';
                    this.style.background = '#f8f9fa';
                    this.style.color = '#666';
                } else {
                    collectedQuestions.push(q.id);
                    this.textContent = 'Â∑≤Êî∂Ëóè';
                    this.style.background = '#f44336';
                    this.style.color = 'white';
                }
                localStorage.setItem('collected', JSON.stringify(collectedQuestions));
            };
            
            const optsContainer = document.getElementById('qOptions');
            optsContainer.innerHTML = '';
            Object.entries(q.options).forEach(([key, val]) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.innerHTML = `
                    <div class="option-label">${key}</div>
                    <div>${val}</div>
                `;
                div.onclick = () => selectOption(key, q.answer, div, q.id);
                optsContainer.appendChild(div);
            });

            const answered = answeredQuestions[q.id];
            if (answered) {
                const opts = document.querySelectorAll('.option');
                opts.forEach((opt, idx) => {
                    const key = Object.keys(q.options)[idx];
                    if (key === q.answer) opt.classList.add('correct');
                    if (key === answered && key !== q.answer) opt.classList.add('wrong');
                });
                showAnalysis(q);
            } else {
                document.getElementById('qAnalysis').classList.remove('show');
            }

            updateProgress();
            
            localStorage.setItem('practiceProgress', JSON.stringify({
                chapters: Array.from(selectedChapters),
                mode: currentMode,
                index: currentIndex
            }));
        }

        function selectOption(selected, correct, element, qid) {
            if (answeredQuestions[qid]) return;
            
            answeredQuestions[qid] = selected;
            localStorage.setItem('answered', JSON.stringify(answeredQuestions));

            const q = filteredQuestions[currentIndex];
            
            if (selected === correct) {
                element.classList.add('correct');
                wrongQuestions = wrongQuestions.filter(id => id !== qid);
            } else {
                element.classList.add('wrong');
                document.querySelectorAll('.option').forEach((opt, idx) => {
                    if (Object.keys(q.options)[idx] === correct) opt.classList.add('correct');
                });
                if (!wrongQuestions.includes(qid)) wrongQuestions.push(qid);
            }
            localStorage.setItem('wrong', JSON.stringify(wrongQuestions));
            
            showAnalysis(q);
            updateStats();
        }

        function showAnalysis(q) {
            document.getElementById('qAnalysis').classList.add('show');
            document.getElementById('qAnalysisText').innerHTML = 
                `<strong>Á≠îÊ°àÔºö${q.answer}</strong><br><br>${q.analysis || 'ÊöÇÊó†Ëß£Êûê'}`;
        }

        function prevQuestion() {
            if (currentIndex > 0) {
                currentIndex--;
                showQuestion();
            }
        }

        function nextQuestion() {
            if (currentIndex < filteredQuestions.length - 1) {
                currentIndex++;
                showQuestion();
            } else {
                if (examTimer) clearInterval(examTimer);
                if (confirm('Â∑≤ÂÆåÊàêÊâÄÊúâÈ¢òÁõÆÔºÅÊòØÂê¶ËøîÂõûÈ¶ñÈ°µÔºü')) {
                    returnHome();
                }
            }
        }

        function jumpToQuestion() {
            const input = document.getElementById('jumpInput');
            const num = parseInt(input.value);
            if (num && num > 0 && num <= filteredQuestions.length) {
                currentIndex = num - 1;
                showQuestion();
                input.value = '';
            } else {
                alert('È¢òÂè∑Ë∂ÖÂá∫ËåÉÂõ¥');
            }
        }

        function toggleMark() {
            const q = filteredQuestions[currentIndex];
            if (markedQuestions.includes(q.id)) {
                markedQuestions = markedQuestions.filter(id => id !== q.id);
            } else {
                markedQuestions.push(q.id);
            }
            localStorage.setItem('marked', JSON.stringify(markedQuestions));
            showQuestion();
        }

        function updateStats() {
            const total = filteredQuestions.length;
            const current = currentIndex + 1;
            const ids = filteredQuestions.map(q => q.id);
            const currentAnswered = Object.entries(answeredQuestions).filter(([id, ans]) => ids.includes(Number(id)));
            const correct = currentAnswered.filter(([id, ans]) => {
                const q = allQuestions.find(x => x.id == id);
                return q && q.answer === ans;
            }).length;
            const wrong = currentAnswered.length - correct;
            const rate = currentAnswered.length ? Math.round(correct / currentAnswered.length * 100) : 0;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statCurrent').textContent = current;
            document.getElementById('statCorrect').textContent = correct;
            document.getElementById('statWrong').textContent = wrong;
            document.getElementById('statRate').textContent = rate + '%';
        }

        function updateProgress() {
            const progress = ((currentIndex + 1) / filteredQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${currentIndex + 1} / ${filteredQuestions.length}`;
        }

        function exportData() {
            const data = {
                answeredQuestions,
                wrongQuestions,
                markedQuestions,
                collectedQuestions,
                exportTime: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ËΩØËÄÉËøõÂ∫¶_${new Date().toLocaleDateString()}.json`;
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    Object.assign(answeredQuestions, data.answeredQuestions || {});
                    wrongQuestions = data.wrongQuestions || wrongQuestions;
                    markedQuestions = data.markedQuestions || markedQuestions;
                    collectedQuestions = data.collectedQuestions || collectedQuestions;
                    localStorage.setItem('answered', JSON.stringify(answeredQuestions));
                    localStorage.setItem('wrong', JSON.stringify(wrongQuestions));
                    localStorage.setItem('marked', JSON.stringify(markedQuestions));
                    localStorage.setItem('collected', JSON.stringify(collectedQuestions));
                    alert('ÂØºÂÖ•ÊàêÂäüÔºÅ');
                    location.reload();
                } catch(err) {
                    alert('Êñá‰ª∂Ê†ºÂºèÈîôËØØ');
                }
            };
            reader.readAsText(file);
        }

        function returnHome() {
            if (examTimer) clearInterval(examTimer);
            
            document.getElementById('mainPanel').style.display = 'block';
            document.getElementById('statsBar').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('questionCard').style.display = 'none';
            
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0 / 0';
            
            document.getElementById('qText').textContent = '';
            document.getElementById('qOptions').innerHTML = '';
            document.getElementById('qAnalysis').classList.remove('show');
            document.getElementById('qAnalysisText').innerHTML = '';
            
            document.getElementById('statTotal').textContent = '0';
            document.getElementById('statCurrent').textContent = '0';
            document.getElementById('statCorrect').textContent = '0';
            document.getElementById('statWrong').textContent = '0';
            document.getElementById('statRate').textContent = '0%';
            
            currentIndex = 0;
            filteredQuestions = [];
            
            const uniqueChapters = [...new Set(allQuestions.map(q => q.chapter))].sort((a,b) => {
                const numA = parseInt(a.match(/\d+/)?.[0]) || 0;
                const numB = parseInt(b.match(/\d+/)?.[0]) || 0;
                return numA - numB;
            });
            
            document.getElementById('globalStats').textContent = 
                `ÂÖ± ${allQuestions.length} ÈÅìÈ¢òÁõÆ ¬∑ ${uniqueChapters.length} ‰∏™Á´†ËäÇ ¬∑ Â∑≤Á≠î ${Object.keys(answeredQuestions).length} È¢ò`;
        }

        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, false);

        document.addEventListener('touchend', (e) => {
            if (document.getElementById('questionCard').style.display === 'none') return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;
            
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                if (diffX > 0) {
                    nextQuestion();
                } else {
                    prevQuestion();
                }
            }
        }, false);

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('questionCard').style.display === 'none') return;
            if (e.key === 'ArrowLeft') prevQuestion();
            if (e.key === 'ArrowRight') nextQuestion();
            if (e.key >= 'A' && e.key <= 'D') {
                const opts = document.querySelectorAll('.option');
                const idx = e.key.charCodeAt(0) - 65;
                if (opts[idx]) opts[idx].click();
            }
            if (e.key === 'Escape') returnHome();
        });

        function showWrongAnalysis() {
            const wrongList = allQuestions.filter(q => wrongQuestions.includes(q.id));
            if (wrongList.length === 0) {
                alert('ÊöÇÊó†ÈîôÈ¢òÔºÅ');
                return;
            }
            let html = `<h3 style="margin-bottom:20px;">ÈîôÈ¢òËß£ÊûêÊ±áÊÄªÔºàÂÖ±${wrongList.length}È¢òÔºâ</h3>`;
            wrongList.forEach((q, i) => {
                html += `
                    <div style="margin:15px 0; padding:15px; border:1px solid #f44336; border-radius:10px; background:white; color:#333;">
                        <p style="font-weight:bold; margin-bottom:8px;">${i+1}. ${q.question}</p>
                        <p style="margin-bottom:4px;"><span style="color:#f44336;">Á≠îÊ°àÔºö</span>${q.answer}</p>
                        <p><span style="color:#f44336;">Ëß£ÊûêÔºö</span>${q.analysis || 'ÊöÇÊó†Ëß£Êûê'}</p>
                    </div>
                `;
            });
            const modal = document.createElement('div');
            modal.style = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); padding:20px; overflow-y:auto; z-index:999;';
            modal.innerHTML = html + '<button onclick="this.parentElement.remove()" style="margin-top:20px; padding:10px 20px; background:#667eea; border:none; border-radius:8px; color:white; font-size:16px;">ÂÖ≥Èó≠</button>';
            document.body.appendChild(modal);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            initPage();
            try {
                const url = 'https://yongheng9251.github.io/ruankao-gaoxiang-practice-system/questions.json';
                const data = await loadQuestionsFromUrl(url);
                if (data && data.length > 0) {
                    allQuestions = data;
                    finishLoading();
                }
            } catch (err) {
                console.log('Ëá™Âä®Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÊâãÂä®‰∏ä‰º†È¢òÂ∫ìÊñá‰ª∂');
            }
        });
    </script>
</body>
</html>